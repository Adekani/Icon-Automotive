<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Icon Automotive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @font-face { font-family: 'Orenburg'; src: 'Orenburg.ttf' format('truetype'); }
        :root { --brand-red: #E60002; --brand-dark: #0a0a0a; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--brand-dark); color: #fff; }
        .font-heading { font-family: 'Orenburg', serif; }
        
        .sidebar-link.active { background: #E60002; color: white; }
        .sidebar-link:hover:not(.active) { background: rgba(255,255,255,0.05); }
        
        td, th { padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .modal { transition: opacity 0.3s ease; }
        .modal.hidden { pointer-events: none; opacity: 0; }
        .modal:not(.hidden) { opacity: 1; pointer-events: auto; }

        input, select, textarea {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-top: 0.25rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #E60002;
        }
        
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #E60002;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body class="h-screen flex overflow-hidden">

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p id="loading-text" class="text-sm tracking-widest">LOADING...</p>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-[#0a0a0a] flex items-center justify-center">
        <div class="bg-[#111] p-10 border border-white/10 rounded-sm w-full max-w-md text-center">
            <h1 class="text-3xl font-heading mb-2">ADMIN LOGIN</h1>
            <p class="text-gray-400 text-sm mb-8">Icon Automotive Management</p>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="email" id="email" placeholder="Email Address" class="w-full bg-white/5 border border-white/10 p-3 rounded" required>
                </div>
                <div>
                    <input type="password" id="password" placeholder="Password (Optional for Magic Link)" class="w-full bg-white/5 border border-white/10 p-3 rounded">
                </div>
                
                <div class="flex flex-col gap-3">
                    <button type="submit" id="login-btn" class="w-full bg-[#E60002] hover:bg-red-700 py-3 font-bold tracking-widest transition-colors">
                        LOGIN WITH PASSWORD
                    </button>
                    <button type="button" onclick="sendMagicLink()" id="magic-btn" class="w-full bg-white/5 hover:bg-white/10 py-3 text-xs font-bold tracking-widest transition-colors text-white">
                        SEND MAGIC LINK INSTEAD
                    </button>
                </div>
            </form>
            <p id="login-msg" class="mt-4 text-sm"></p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-64 bg-[#111] border-r border-white/5 flex flex-col hidden" id="sidebar">
        <div class="p-6 border-b border-white/5">
            <h1 class="text-2xl font-heading text-[#E60002]">ICON ADMIN</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showPage('dashboard')" class="sidebar-link active w-full text-left px-4 py-3 rounded-sm flex items-center gap-3">
                <i class="fas fa-car"></i> Listings
            </button>
            <button onclick="showPage('audit')" class="sidebar-link w-full text-left px-4 py-3 rounded-sm flex items-center gap-3">
                <i class="fas fa-history"></i> Audit Log
            </button>
        </nav>
        <div class="p-4 border-t border-white/5">
            <div class="text-xs text-gray-500 mb-2">Logged in as:</div>
            <div id="user-email" class="text-sm truncate mb-4 font-bold">...</div>
            <button onclick="handleLogout()" class="w-full py-2 border border-white/20 hover:bg-white/5 text-xs tracking-widest">LOGOUT</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto bg-[#0a0a0a] relative hidden" id="main-content">
        <div id="page-dashboard" class="p-8">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-heading">VEHICLE LISTINGS</h2>
                    <p class="text-gray-400 text-sm mt-1">Manage your inventory</p>
                </div>
                <button onclick="alert('Functionality coming soon - ensure data table loads first')" class="bg-[#E60002] hover:bg-red-700 px-6 py-3 font-bold text-sm tracking-widest flex items-center gap-2">
                    <i class="fas fa-plus"></i> ADD VEHICLE
                </button>
            </div>
            <div class="bg-[#111] border border-white/5 rounded-sm overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-500 uppercase text-xs tracking-wider bg-white/5">
                            <th class="w-24">Image</th>
                            <th>Brand / Model</th>
                            <th>Year</th>
                            <th>Price (₦)</th>
                            <th>Status</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cars-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="page-audit" class="p-8 hidden">
            <h2 class="text-3xl font-heading mb-8">AUDIT LOG</h2>
            <div class="bg-[#111] border border-white/5 rounded-sm overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-500 uppercase text-xs tracking-wider bg-white/5">
                            <th>Time</th>
                            <th>Action</th>
                            <th>Admin</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="audit-table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // 1. GLOBAL CONFIG (Only declare ONCE)
        const SUPABASE_URL = 'https://dpzvjsfgilnuzedghfww.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwenZqc2ZnaWxudXplZGdoZnd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjUyMTcsImV4cCI6MjA4MzEwMTIxN30.KjnG8hVXcWshG1XIDOrWEnM1ITiLT2Nzu3b1Z1ix-8Q';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let allCars = [];

        // 2. UI HELPERS
        const showLoading = (msg) => {
            const overlay = document.getElementById('loading-overlay');
            const text = document.getElementById('loading-text');
            if(overlay) overlay.style.display = 'flex';
            if(text) text.innerText = msg;
        }
        const hideLoading = () => {
            const overlay = document.getElementById('loading-overlay');
            if(overlay) overlay.style.display = 'none';
        }

        // 3. AUTH FUNCTIONS (Global Scope)
        async function sendMagicLink() {
            console.log("Attempting to send Magic Link...");
            const emailInput = document.getElementById('email');
            const btn = document.getElementById('magic-btn');
            const msg = document.getElementById('login-msg');
            
            const email = emailInput.value.trim();
            if(!email) return alert("Please enter your email");
            
            btn.disabled = true;
            btn.innerText = "SENDING...";
            
            try {
                const { error } = await supabase.auth.signInWithOtp({ 
                    email: email,
                    options: {
                        emailRedirectTo: window.location.href 
                    }
                });
                
                if(error) throw error;

                msg.innerText = "Link sent! Check your inbox."; 
                msg.style.color = '#22c55e';
                console.log("Magic link request successful.");
            } catch (err) {
                console.error("Magic Link Error:", err);
                msg.innerText = err.message; 
                msg.style.color = 'red'; 
            } finally {
                btn.disabled = false;
                btn.innerText = "SEND MAGIC LINK INSTEAD";
            }
        }

        async function checkAdminAndLogin(user) {
            console.log("Verifying admin permission for:", user.email);
            const { data, error } = await supabase
                .from('allowed_admins')
                .select('email')
                .eq('email', user.email)
                .maybeSingle();
            
            if (error) {
                console.error("CheckAdmin Error:", error);
                hideLoading();
                return;
            }

            if (!data) {
                hideLoading();
                alert("Unauthorized: " + user.email + " is not in the allowed_admins list.");
                await supabase.auth.signOut();
                return;
            }

            currentUser = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('flex');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('user-email').innerText = user.email;
            hideLoading();
            fetchCars();
        }

        async function handleLogout() {
            showLoading("LOGGING OUT...");
            await supabase.auth.signOut();
            window.location.reload();
        }

        // 4. DATA FUNCTIONS
        async function fetchCars() {
            const { data, error } = await supabase.from('cars').select('*').order('created_at', { ascending: false });
            if (!error) {
                allCars = data;
                renderCarsTable();
            } else {
                console.error("Fetch Cars Error:", error);
            }
        }

        function renderCarsTable() {
            const tbody = document.getElementById('cars-table-body');
            if(!tbody) return;
            tbody.innerHTML = allCars.map(car => `
                <tr>
                    <td><img src="${car.images?.[0] || 'https://via.placeholder.com/64'}" class="w-16 h-12 object-cover"></td>
                    <td>${car.brand} ${car.model}</td>
                    <td>${car.year}</td>
                    <td class="text-[#E60002]">₦${car.price.toLocaleString()}</td>
                    <td>${car.usage_state}</td>
                    <td class="text-right">
                        <button class="text-blue-400 mr-2"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function showPage(pageId) {
            document.getElementById('page-dashboard').classList.toggle('hidden', pageId !== 'dashboard');
            document.getElementById('page-audit').classList.toggle('hidden', pageId !== 'audit');
        }

        // 5. EVENT LISTENERS
        window.addEventListener('load', async () => {
            showLoading("CHECKING SESSION...");
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                checkAdminAndLogin(session.user);
            } else {
                hideLoading();
            }

            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    showLoading("VERIFYING ADMIN...");
                    checkAdminAndLogin(session.user);
                }
            });
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');
            
            if(!password) {
                sendMagicLink();
                return;
            }

            btn.disabled = true;
            btn.innerText = "LOGGING IN...";
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if(error) {
                btn.disabled = false;
                btn.innerText = "LOGIN WITH PASSWORD";
                alert(error.message);
            }
        });
    </script>
</body>
</html>
